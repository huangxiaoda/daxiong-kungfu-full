<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ç†Šå­¦æ­¦åŠŸï¼šåŠŸå¤«èŠ‚å¥æŒ‘æˆ˜</title>
    <link rel="icon" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">    
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* é¡µé¢æ•´ä½“æ ·å¼ */
        body {
            font-family: 'Zhi Mang Xing', cursive, sans-serif;
            background-color: #f7e0b5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }
        
        /* æ¸¸æˆå®¹å™¨ */
        .game-container {
            width: 95%;
            max-width: 900px;
            height: 800px;
            background: linear-gradient(to bottom, #aed581, #dce775);
            border-radius: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 8px solid #8bc34a;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .info-bar {
            background-color: #558b2f;
            color: #fff;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.6em;
            font-weight: bold;
            border-bottom: 4px solid #33691e;
            font-family: 'Press Start 2P', cursive;
        }
        
        .info-bar span {
            margin: 0 15px;
        }
        
        .info-bar .level {
            font-size: 0.8em;
            color: #cddc39;
        }
        
        #bgMusicToggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
            transition: color 0.3s ease;
        }
        
        #bgMusicToggle:hover {
            color: #cddc39;
        }
        
        /* æ¸¸æˆåŒºåŸŸ */
        .play-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
        }
        
        /* å¸ˆå‚…å›¾æ ‡ */
        #master {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 7em;
            color: rgba(0, 0, 0, 0.7);
            user-select: none;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 5;
            line-height: 1;
        }
        
        /* å¸ˆå‚…çš„æ‹›å¼æç¤º */
        .master-move-display {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 4em;
            color: #d84315;
            font-weight: bold;
            text-align: center;
            min-width: 150px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 15;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .master-move-display.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        
        .master-move-display .text {
            font-size: 0.4em;
            color: #333;
            margin-top: 5px;
        }
        
        /* å¤§ç†Šå›¾æ ‡ */
        #bear {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9em;
            color: #6d4c41;
            user-select: none;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 5;
            line-height: 1;
            display: block;
        }
        
        /* ç©å®¶æ“ä½œæŒ‰é’® */
        .player-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 10;
            max-width: 250px;
        }
        
        .action-button {
            width: 100px;
            height: 100px;
            background-color: #ffb300;
            border: 3px solid #fb8c00;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-button:hover:not(:disabled) {
            background-color: #ffa000;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .action-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #e65100;
        }
        
        .action-button:disabled {
            background-color: #cccccc;
            border-color: #bbbbbb;
            color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .action-button .text {
            font-size: 0.4em;
            color: #333;
            margin-top: 5px;
        }
        
        /* æ¸¸æˆåé¦ˆæç¤º */
        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.6);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .feedback.show {
            opacity: 1;
            transform: translate(-50%, -70%);
        }
        
        .feedback.wrong {
            color: #F44336;
        }
        
        .feedback.combo {
            color: #FFEB3B;
            font-size: 7em;
            animation: pulse 0.5s ease-out forwards;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -60%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(1); opacity: 0; }
        }
        
        /* æ¸¸æˆç»“æŸæˆ–å¼€å§‹å‰çš„å åŠ å±‚ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
            flex-direction: column;
            color: white;
            font-size: 2.2em;
            text-align: center;
            border-radius: 25px;
        }
        
        .overlay h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .overlay p {
            font-size: 0.8em;
            margin-top: -10px;
            margin-bottom: 30px;
        }
        
        .overlay button {
            background-color: #ffb300;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .overlay button:hover {
            background-color: #ffa000;
        }
        
        .overlay.hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }
        
        /* æ”¾æ¾éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .relax-music-player {
            width: calc(100% - 40px);
            background-color: #e0f2f7;
            padding: 15px 20px;
            border-radius: 15px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #b2ebf2;
            z-index: 5;
        }
        
        .relax-music-player h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #00bcd4;
            font-size: 1.2em;
        }
        
        .relax-music-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .relax-music-controls button {
            background-color: #4dd0e1;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .relax-music-controls button:hover {
            background-color: #26c6da;
        }
        
        .relax-music-controls input[type="range"] {
            width: 100px;
            -webkit-appearance: none;
            height: 6px;
            background: #b2ebf2;
            border-radius: 3px;
            outline: none;
        }
        
        .relax-music-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00bcd4;
            cursor: pointer;
        }
        
        .relax-music-controls label {
            font-size: 0.9em;
            color: #00838f;
        }
        
        /* éŸ³ä¹é€‰æ‹©å™¨å¸ƒå±€è°ƒæ•´ */
        .music-selector-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .music-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            min-width: 180px;
            justify-content: center;
        }
        
        .music-selector label {
            font-size: 0.9em;
            color: #00838f;
            white-space: nowrap;
        }
        
        .music-selector select {
            padding: 5px 8px;
            border-radius: 8px;
            border: 1px solid #00bcd4;
            background-color: #e0f7fa;
            color: #00838f;
            font-size: 0.9em;
            cursor: pointer;
            flex-grow: 1;
            min-width: 80px;
            max-width: 180px;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .game-container {
                height: 780px;
                width: 98%;
                border-radius: 20px;
            }
            
            .info-bar {
                font-size: 1.2em;
                padding: 10px 15px;
            }
            
            #master {
                top: 5px;
                font-size: 5em;
            }
            
            #bear {
                bottom: 100px;
                font-size: 7em;
            }
            
            .master-move-display {
                top: 20%;
                font-size: 3em;
                padding: 10px 15px;
                min-height: 60px;
            }
            
            .player-controls {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
                bottom: 10px;
                max-width: 200px;
            }
            
            .action-button {
                width: 70px;
                height: 70px;
                font-size: 2.2em;
            }
            
            .action-button .text {
                font-size: 0.3em;
            }
            
            .feedback {
                font-size: 4em;
            }
            
            .feedback.combo {
                font-size: 5em;
            }
            
            .overlay {
                font-size: 1.5em;
            }
            
            .overlay h2 {
                font-size: 1.2em;
            }
            
            .overlay p {
                font-size: 0.7em;
            }
            
            .overlay button {
                padding: 10px 20px;
                font-size: 1.2em;
            }
            
            .relax-music-player {
                padding: 10px 15px;
                margin-top: 15px;
            }
            
            .relax-music-player h3 {
                font-size: 1.1em;
            }
            
            .relax-music-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .relax-music-controls input[type="range"] {
                width: 80%;
            }
            
            .music-selector-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                width: 100%;
            }
            
            .music-selector {
                width: 100%;
                justify-content: flex-start;
            }
            
            .music-selector select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- æ¸¸æˆèƒŒæ™¯éŸ³ä¹ -->
        <audio id="game-bg-music" loop>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ¸¸æˆèƒŒæ™¯éŸ³ä¹ã€‚
        </audio>
        
        <div class="info-bar">
            <span>æ—¶é—´: <span id="timer">60</span>s</span>
            <span>åˆ†æ•°: <span id="score">0</span></span>
            <span>è¿å‡»: <span id="combo">0</span></span>
            <span class="level">ç­‰çº§: <span id="level">å­¦å¾’</span></span>
            <button id="bgMusicToggle" title="åˆ‡æ¢èƒŒæ™¯éŸ³ä¹">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
        
        <div class="play-area">
            <!-- å¸ˆå‚…å›¾æ ‡ -->
            <div id="master" class="character">ğŸ‘¨â€ğŸ«</div>
            
            <!-- å¤§ç†Šå›¾æ ‡ -->
            <div id="bear" class="character">ğŸ»</div>
            
            <div id="masterMoveDisplay" class="master-move-display">
                <span class="emoji"></span>
                <div class="text"></div>
            </div>
            
            <div id="feedback" class="feedback"></div>
            
            <div class="player-controls">
                <button class="action-button" data-action="left-punch">
                    <span>ğŸ‘Š</span><div class="text">å·¦æ‹³</div>
                </button>
                <button class="action-button" data-action="right-punch">
                    <span>ğŸ¤œ</span><div class="text">å³æ‹³</div>
                </button>
                <button class="action-button" data-action="up-kick">
                    <span>ğŸ¤¸</span><div class="text">ä¸Šè¸¢</div>
                </button>
                <button class="action-button" data-action="down-block">
                    <span>ğŸ›¡ï¸</span><div class="text">ä¸‹æŒ¡</div>
                </button>
                <button class="action-button" data-action="jump">
                    <span>â¬†ï¸</span><div class="text">è·³è·ƒ</div>
                </button>
                <button class="action-button" data-action="crouch">
                    <span>â¤µï¸</span><div class="text">è¹²ä¼</div>
                </button>
            </div>
        </div>
        
        <div class="relax-music-player">
            <div class="music-selector-row">
                <div class="music-selector">
                    <label for="bgMusicSelector">æ¸¸æˆéŸ³ä¹:</label>
                    <select id="bgMusicSelector"></select>
                </div>
                <div class="music-selector">
                    <label for="relaxMusicSelector">æ”¾æ¾éŸ³ä¹:</label>
                    <select id="relaxMusicSelector"></select>
                </div>
            </div>
            
            <h3>ğŸµ æ”¾æ¾éŸ³ä¹æ§åˆ¶ ğŸµ</h3>
            
            <audio id="relax-audio" loop>
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ”¾æ¾éŸ³ä¹ã€‚
            </audio>
            
            <div class="relax-music-controls">
                <button id="relaxPlayButton">æ’­æ”¾</button>
                <button id="relaxPauseButton">æš‚åœ</button>
                <label for="relaxVolumeSlider">éŸ³é‡:</label>
                <input type="range" id="relaxVolumeSlider" min="0" max="1" step="0.05" value="0.5">
            </div>
        </div>
        
        <div class="overlay" id="gameOverlay">
            <h2>å¤§ç†Šå­¦æ­¦åŠŸï¼</h2>
            <p>çœ‹å¸ˆå‚…æ¼”ç¤ºï¼Œå¿«é€Ÿç‚¹å‡»å¯¹åº”çš„æ‹›å¼ï¼</p>
            <button id="startButton">å¼€å§‹ç»ƒåŠŸ</button>
        </div>
    </div>
    
    <script>
        // ===== å…ƒç´ è·å– =====
        const timerElement = document.getElementById('timer');
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const levelElement = document.getElementById('level');
        const masterMoveDisplay = document.getElementById('masterMoveDisplay');
        const masterMoveEmoji = masterMoveDisplay.querySelector('.emoji');
        const masterMoveText = masterMoveDisplay.querySelector('.text');
        const actionButtons = document.querySelectorAll('.action-button');
        const feedbackDisplay = document.getElementById('feedback');
        const gameOverlay = document.getElementById('gameOverlay');
        const startButton = document.getElementById('startButton');
        
        // æ¸¸æˆéŸ³ä¹å…ƒç´ 
        const gameBgMusic = document.getElementById('game-bg-music');
        const bgMusicToggle = document.getElementById('bgMusicToggle');
        const bgMusicIcon = bgMusicToggle.querySelector('i');
        const bgMusicSelector = document.getElementById('bgMusicSelector');
        gameBgMusic.volume = 0.3;
        let isGameBgMusicPlaying = false;
        
        // æ”¾æ¾éŸ³ä¹å…ƒç´ 
        const relaxAudio = document.getElementById('relax-audio');
        const relaxPlayButton = document.getElementById('relaxPlayButton');
        const relaxPauseButton = document.getElementById('relaxPauseButton');
        const relaxVolumeSlider = document.getElementById('relaxVolumeSlider');
        const relaxMusicSelector = document.getElementById('relaxMusicSelector');
        relaxAudio.volume = relaxVolumeSlider.value;
        
        // ===== æ¸¸æˆçŠ¶æ€å˜é‡ =====
        let score = 0;
        let combo = 0;
        let timeLeft = 60;
        let gameInterval;
        let moveInterval;
        let isGameRunning = false;
        let expectedMoveId = null;
        let moveTimeout = null;
        let level = 1;
        
        // ===== æ¸¸æˆæ•°æ® =====
        const moves = [
            { id: 'left-punch', emoji: 'ğŸ‘Š', text: 'å·¦æ‹³' },
            { id: 'right-punch', emoji: 'ğŸ¤œ', text: 'å³æ‹³' },
            { id: 'up-kick', emoji: 'ğŸ¤¸', text: 'ä¸Šè¸¢' },
            { id: 'down-block', emoji: 'ğŸ›¡ï¸', text: 'ä¸‹æŒ¡' },
            { id: 'jump', emoji: 'â¬†ï¸', text: 'è·³è·ƒ' },
            { id: 'crouch', emoji: 'â¤µï¸', text: 'è¹²ä¼' }
        ];
        
        const levels = [
            { scoreThreshold: 0, name: 'å­¦å¾’', moveSpeed: 1500 },
            { scoreThreshold: 100, name: 'å°ç†Šæ­¦è€…', moveSpeed: 1200 },
            { scoreThreshold: 300, name: 'åŠŸå¤«å¤§ç†Š', moveSpeed: 1000 },
            { scoreThreshold: 600, name: 'å®—å¸ˆä¹‹å¾’', moveSpeed: 800 },
            { scoreThreshold: 1000, name: 'ç†Šéœ¸å¤©ä¸‹', moveSpeed: 600 }
        ];
        
        // éŸ³ä¹åˆ—è¡¨
        const gameMusicList = [
            { name: "åŠŸå¤«èŠ‚å¥", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3" },
            { name: "æŒ¯å¥‹æ‰“å‡»", src: "https://assets.mixkit.co/sfx/preview/mixkit-martial-arts-punch-2047.mp3" },
            { name: "å±±æ—ä¿®ç‚¼", src: "https://www.bensound.com/bensound-music/bensound-littleidea.mp3" }
        ];
        
        const relaxMusicList = [
            { name: "æ£®æ—æ‘‡ç¯®æ›²", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Forest-Lullaby.mp3" },
            { name: "é›¨æ—å†¥æƒ³", src: "https://assets.mixkit.co/sfx/preview/mixkit-forest-stream-loop-2009.mp3" },
            { name: "æµ·æµªå£°", src: "https://www.bensound.com/bensound-music/bensound-relaxing.mp3" }
        ];
        
        // ===== éŸ³ä¹æ’­æ”¾è¾…åŠ©å‡½æ•° =====
        async function loadAndPlayMusic(audioElement, src, shouldPlay) {
            console.log(`å°è¯•åŠ è½½: ${src}, é¢„æœŸæ’­æ”¾: ${shouldPlay}`);
            audioElement.src = src;
            audioElement.load();
            
            if (shouldPlay) {
                try {
                    await new Promise((resolve, reject) => {
                        const onCanPlayThrough = () => {
                            console.log(`Audio canplaythrough: ${src}`);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onLoadedData = () => {
                            console.log(`Audio loadeddata: ${src}`);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            console.error(`Audio error during load/play: ${src}`, e);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            reject(new Error(`Audio load error for ${src}: ${e.message || e.type}`));
                        };
                        
                        audioElement.addEventListener('canplaythrough', onCanPlayThrough);
                        audioElement.addEventListener('loadeddata', onLoadedData);
                        audioElement.addEventListener('error', onError);
                        
                        if (audioElement.readyState >= 4) {
                            onCanPlayThrough();
                        } else if (audioElement.readyState >= 2) {
                            onLoadedData();
                        }
                        
                        setTimeout(() => {
                            reject(new Error(`Audio load timeout for ${src}`));
                        }, 7000);
                    });
                    
                    await audioElement.play();
                    console.log(`éŸ³ä¹ ${src} æˆåŠŸæ’­æ”¾ã€‚`);
                    return true;
                } catch (e) {
                    console.warn(`éŸ³ä¹æ’­æ”¾å¤±è´¥ (URL: ${src})ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’æˆ–é“¾æ¥å¤±æ•ˆ/æ ¼å¼é”™è¯¯:`, e);
                    return false;
                }
            }
            return false;
        }
        
        // å¡«å……éŸ³ä¹é€‰æ‹©å™¨ä¸‹æ‹‰èœå•
        function populateMusicSelectors() {
            bgMusicSelector.innerHTML = '';
            relaxMusicSelector.innerHTML = '';
            
            gameMusicList.forEach((music) => {
                const option = document.createElement('option');
                option.value = music.src;
                option.textContent = music.name;
                bgMusicSelector.appendChild(option);
            });
            
            if (gameMusicList.length > 0) {
                gameBgMusic.src = gameMusicList[0].src;
                gameBgMusic.load();
            }
            
            relaxMusicList.forEach((music) => {
                const option = document.createElement('option');
                option.value = music.src;
                option.textContent = music.name;
                relaxMusicSelector.appendChild(option);
            });
            
            if (relaxMusicList.length > 0) {
                relaxAudio.src = relaxMusicList[0].src;
                relaxAudio.load();
            }
        }
        
        // ===== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ =====
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGame() {
            score = 0;
            combo = 0;
            timeLeft = 60;
            level = 1;
            
            scoreElement.textContent = score;
            comboElement.textContent = combo;
            timerElement.textContent = timeLeft;
            levelElement.textContent = levels[0].name;
            
            // ç¡®ä¿åœ¨é‡ç½®æ—¶æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            
            if (moveTimeout) {
                clearTimeout(moveTimeout);
                moveTimeout = null;
            }
            
            isGameRunning = false;
            expectedMoveId = null;
            
            masterMoveDisplay.classList.remove('show');
            feedbackDisplay.classList.remove('show', 'correct', 'wrong', 'combo');
            feedbackDisplay.textContent = '';
            
            enableActionButtons(true);
            
            gameBgMusic.pause();
            gameBgMusic.currentTime = 0;
            isGameBgMusicPlaying = false;
            bgMusicIcon.classList.remove('fa-volume-mute');
            bgMusicIcon.classList.add('fa-volume-up');
            
            relaxAudio.pause();
            relaxAudio.currentTime = 0;
        }
        
        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            console.log("startGame called.");
            
            // å¦‚æœæ¸¸æˆå·²ç»åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåˆ™å¿½ç•¥é‡å¤è°ƒç”¨
            if (isGameRunning) {
                console.log("Game is already running or starting, ignoring duplicate call.");
                return;
            }
            
            resetGame();
            
            // å…³é”®ï¼šåœ¨è®¾ç½®isGameRunning=trueä¹‹å‰å…ˆéšè—overlayï¼Œé˜²æ­¢ç«äº‰æ¡ä»¶
            gameOverlay.classList.add('hidden');
            
            // å¢åŠ ä¸€ä¸ªçŸ­å»¶è¿Ÿï¼Œç¡®ä¿æµè§ˆå™¨æœ‰è¶³å¤Ÿæ—¶é—´å¤„ç† DOM æ›´æ–°å’Œæ¸²æŸ“
            await new Promise(resolve => setTimeout(resolve, 100));
            
            isGameRunning = true;
            
            try {
                gameInterval = setInterval(updateTimer, 1000);
                console.log("Game interval set with ID:", gameInterval);
            } catch (error) {
                console.error("Failed to set gameInterval:", error);
                isGameRunning = false;
                gameOverlay.classList.remove('hidden');
                return;
            }
            
            startNewMoveSequence();
            
            // éŸ³ä¹æ’­æ”¾é€»è¾‘
            if (isGameBgMusicPlaying) {
                await loadAndPlayMusic(gameBgMusic, bgMusicSelector.value, true);
            }
            
            relaxAudio.pause();
            console.log("startGame finished. Game is running.");
        }
        
        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            // åªæœ‰å½“æ¸¸æˆæ­£åœ¨è¿è¡Œæ—¶æ‰æ›´æ–°æ—¶é—´
            if (!isGameRunning) {
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                console.log("updateTimer called but game is not running.");
                return;
            }
            
            timeLeft--;
            timerElement.textContent = timeLeft;
            console.log("Time left:", timeLeft, " (isGameRunning:", isGameRunning, ")");
            
            if (timeLeft <= 0) {
                endGame();
            }
        }
        
        // å¼€å§‹æ–°çš„æ‹›å¼åºåˆ—
        function startNewMoveSequence() {
            if (moveInterval) clearInterval(moveInterval);
            
            let currentLevelData = levels[0];
            for (let i = levels.length - 1; i >= 0; i--) {
                if (score >= levels[i].scoreThreshold) {
                    currentLevelData = levels[i];
                    level = i + 1;
                    break;
                }
            }
            
            levelElement.textContent = currentLevelData.name;
            moveInterval = setInterval(showNextMove, currentLevelData.moveSpeed);
            showNextMove();
        }
        
        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ‹›å¼
        function showNextMove() {
            if (!isGameRunning) return;
            
            clearTimeout(moveTimeout);
            
            if (expectedMoveId !== null) {
                handleWrongGuess(null);
            }
            
            masterMoveDisplay.classList.remove('show');
            
            const randomIndex = Math.floor(Math.random() * moves.length);
            const nextMove = moves[randomIndex];
            
            masterMoveEmoji.textContent = nextMove.emoji;
            masterMoveText.textContent = nextMove.text;
            masterMoveDisplay.classList.add('show');
            
            expectedMoveId = nextMove.id;
            
            actionButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'wrong');
            });
            
            const currentLevelData = levels.find(l => score >= l.scoreThreshold) || levels[levels.length - 1];
            
            moveTimeout = setTimeout(() => {
                if (expectedMoveId !== null && isGameRunning) {
                    handleWrongGuess(null);
                }
            }, currentLevelData.moveSpeed - 200);
        }
        
        // å¤„ç†ç©å®¶åŠ¨ä½œ
        function handlePlayerAction(event) {
            console.log("Player action clicked. Expected:", expectedMoveId, "Clicked:", event.currentTarget.dataset.action);
            
            if (!isGameRunning || expectedMoveId === null) {
                console.log("Action ignored: Not running or no expected move.");
                return;
            }
            
            clearTimeout(moveTimeout);
            
            const clickedAction = event.currentTarget.dataset.action;
            const isCorrect = (clickedAction === expectedMoveId);
            
            expectedMoveId = null;
            masterMoveDisplay.classList.remove('show');
            enableActionButtons(false);
            
            if (isCorrect) {
                console.log("Correct!");
                score += (10 + combo * 2);
                combo++;
                
                scoreElement.textContent = score;
                comboElement.textContent = combo;
                
                if (combo > 1) {
                    showFeedback(`è¿å‡» x${combo}!`, 'combo');
                } else {
                    showFeedback('æ­£ç¡®ï¼', 'correct');
                }
                
                const nextLevelThreshold = levels[level] ? levels[level].scoreThreshold : Infinity;
                
                if (score >= nextLevelThreshold) {
                    level++;
                    levelElement.textContent = levels[level-1].name;
                    startNewMoveSequence();
                    showFeedback(`ç­‰çº§æå‡ï¼`, 'combo');
                }
            } else {
                console.log("Wrong!");
                handleWrongGuess(event.currentTarget);
            }
        }
        
        // å¤„ç†é”™è¯¯çŒœæµ‹
        function handleWrongGuess(clickedButton) {
            score = Math.max(0, score - 5);
            combo = 0;
            
            scoreElement.textContent = score;
            comboElement.textContent = combo;
            
            showFeedback('é”™è¯¯ï¼', 'wrong');
            
            if (clickedButton) {
                clickedButton.classList.add('wrong');
            }
            
            expectedMoveId = null;
        }
        
        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(text, type) {
            feedbackDisplay.classList.remove('show', 'correct', 'wrong', 'combo');
            feedbackDisplay.textContent = text;
            feedbackDisplay.classList.add('show');
            
            if (type) {
                feedbackDisplay.classList.add(type);
            }
            
            setTimeout(() => {
                feedbackDisplay.classList.remove('show');
            }, 1000);
        }
        
        // å¯ç”¨/ç¦ç”¨åŠ¨ä½œæŒ‰é’®
        function enableActionButtons(enable) {
            actionButtons.forEach(button => {
                button.disabled = !enable;
            });
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            clearInterval(gameInterval);
            clearInterval(moveInterval);
            clearTimeout(moveTimeout);
            
            isGameRunning = false;
            enableActionButtons(false);
            masterMoveDisplay.classList.remove('show');
            expectedMoveId = null;
            
            gameBgMusic.pause();
            gameBgMusic.currentTime = 0;
            isGameBgMusicPlaying = false;
            bgMusicIcon.classList.remove('fa-volume-mute');
            bgMusicIcon.classList.add('fa-volume-up');
            
            gameOverlay.classList.remove('hidden');
            gameOverlay.querySelector('h2').textContent = 'ç»ƒåŠŸç»“æŸï¼';
            gameOverlay.querySelector('p').textContent = `ä½ çš„æœ€ç»ˆåˆ†æ•°æ˜¯ï¼š${score} åˆ†ï¼Œå¤§ç†Šè¾¾åˆ°äº† ${levelElement.textContent} å¢ƒç•Œï¼`;
            gameOverlay.querySelector('button').textContent = 'å†æ¥ä¸€å±€';
        }
        
        // ===== äº‹ä»¶ç›‘å¬å™¨ =====
        
        actionButtons.forEach(button => {
            button.addEventListener('click', handlePlayerAction);
        });
        
        bgMusicToggle.addEventListener('click', async () => {
            if (gameBgMusic.paused) {
                const success = await loadAndPlayMusic(gameBgMusic, bgMusicSelector.value, true);
                if (success) {
                    isGameBgMusicPlaying = true;
                    bgMusicIcon.classList.remove('fa-volume-mute');
                    bgMusicIcon.classList.add('fa-volume-up');
                    
                    if (!relaxAudio.paused) {
                        relaxAudio.pause();
                    }
                }
            } else {
                gameBgMusic.pause();
                isGameBgMusicPlaying = false;
                bgMusicIcon.classList.remove('fa-volume-up');
                bgMusicIcon.classList.add('fa-volume-mute');
            }
        });
        
        bgMusicSelector.addEventListener('change', async (e) => {
            const newSrc = e.target.value;
            const wasPlaying = isGameBgMusicPlaying;
            gameBgMusic.pause();
            gameBgMusic.currentTime = 0;
            const success = await loadAndPlayMusic(gameBgMusic, newSrc, wasPlaying);
            if (success) {
                isGameBgMusicPlaying = true;
                bgMusicIcon.classList.remove('fa-volume-mute');
                bgMusicIcon.classList.add('fa-volume-up');
                
                if (!relaxAudio.paused) {
                    relaxAudio.pause();
                }
            } else {
                isGameBgMusicPlaying = false;
                bgMusicIcon.classList.remove('fa-volume-up');
                bgMusicIcon.classList.add('fa-volume-mute');
            }
        });
        
        relaxPlayButton.addEventListener('click', async () => {
            const success = await loadAndPlayMusic(relaxAudio, relaxMusicSelector.value, true);
            if (success) {
                if (!gameBgMusic.paused) {
                    gameBgMusic.pause();
                    isGameBgMusicPlaying = false;
                    bgMusicIcon.classList.remove('fa-volume-up');
                    bgMusicIcon.classList.add('fa-volume-mute');
                }
            }
        });
        
        relaxPauseButton.addEventListener('click', () => {
            relaxAudio.pause();
        });
        
        relaxVolumeSlider.addEventListener('input', () => {
            relaxAudio.volume = relaxVolumeSlider.value;
        });
        
        relaxMusicSelector.addEventListener('change', async (e) => {
            const newSrc = e.target.value;
            const wasRelaxPlaying = !relaxAudio.paused;
            relaxAudio.pause();
            relaxAudio.currentTime = 0;
            const success = await loadAndPlayMusic(relaxAudio, newSrc, wasRelaxPlaying);
            if (success) {
                if (!gameBgMusic.paused) {
                    gameBgMusic.pause();
                    isGameBgMusicPlaying = false;
                    bgMusicIcon.classList.remove('fa-volume-up');
                    bgMusicIcon.classList.add('fa-volume-mute');
                }
            }
        });
        
        // ===== åˆå§‹è®¾ç½® =====
        document.addEventListener('DOMContentLoaded', () => {
            populateMusicSelectors();
            gameOverlay.classList.remove('hidden');
            startButton.addEventListener('click', startGame);
            resetGame();
        });
    </script>
</body>
</html>

